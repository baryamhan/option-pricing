<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opsiyon Fiyatlama</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="dashboard-container">
        <h2>Hoş Geldiniz, <span id="username"></span></h2>

        <form id="optionForm">
            <!-- 1. Dayanak Varlık Seçimi -->
            <label for="asset">Dayanak Varlık:</label>
            <select id="asset" onchange="updateAssetDetails()"></select>

            <!-- 2. Dayanak Fiyatı -->
            <label for="spotPrice">Dayanak Fiyatı:</label>
            <input type="number" id="spotPrice" value="100" readonly>

            <!-- 3. Call/Put Seçimi -->
            <label for="optionType">Opsiyon Türü:</label>
            <select id="optionType">
                <option value="Call" selected>Call</option>
                <option value="Put">Put</option>
            </select>

            <!-- 4. Kullanım Fiyatı (Strike) -->
            <label for="strike">Kullanım Fiyatı (Strike):</label>
            <input type="number" id="strike">

            <!-- 5. Vade Sonu Tarihi -->
            <label for="expiry">Vade Sonu Tarihi:</label>
            <input type="date" id="expiry" onchange="calculateDaysToExpiry()">

            <!-- 6. Vadeye Kalan Gün -->
            <label for="daysToExpiry">Vadeye Kalan Gün:</label>
            <input type="number" id="daysToExpiry" readonly>

            <!-- 7. Temettü Değeri -->
            <label for="dividend">Temettü Değeri (%):</label>
            <input type="number" id="dividend" readonly>

            <!-- 8. Temettü Tarihi -->
            <label for="dividendDate">Temettü Tarihi:</label>
            <input type="date" id="dividendDate" readonly>

            <!-- 9. Faiz Oranı -->
            <label for="interestRate">Faiz Oranı (%):</label>
            <input type="number" id="interestRate" readonly>

            <!-- 10. Önerilen Volatilite -->
            <label for="volatility">Önerilen Volatilite (%):</label>
            <input type="number" id="volatility" readonly placeholder="Hesaplandıktan sonra görünecek">

            <!-- Hesapla Butonu -->
            <button type="button" onclick="calculateOptionPrice()">Hesapla</button>

            <!-- Hesaplanan Opsiyon Fiyatı -->
            <div class="result-box">
                <label>Opsiyon Önerilen Fiyatı:</label>
                <input type="text" id="optionPrice" readonly class="bold-result">
            </div>
        </form>

        <button class="logout" onclick="logout()">Çıkış Yap</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const loggedInUser = localStorage.getItem("loggedInUser");
            if (!loggedInUser) {
                alert("Lütfen önce giriş yapın!");
                window.location.href = "index.html";
            } else {
                document.getElementById("username").innerText = loggedInUser;
                loadDataForUser(loggedInUser);
            }
        });

        function loadDataForUser(user) {
            const jsonFile = user === "YBA" 
                ? "https://cdn.jsdelivr.net/gh/baryamhan/option-pricing@main/yba.json"
                : "https://cdn.jsdelivr.net/gh/baryamhan/option-pricing@main/sube.json";

            fetchData(jsonFile);
        }

        async function fetchData(jsonFile) {
            try {
                const response = await fetch(jsonFile);
                const data = await response.json();
                populateAssetDropdown(data);
            } catch (error) {
                console.error("JSON verisi çekilemedi:", error);
                alert("Verileri yüklerken hata oluştu. Lütfen konsolu kontrol edin.");
            }
        }

        function populateAssetDropdown(data) {
            const assetDropdown = document.getElementById("asset");
            assetDropdown.innerHTML = ""; 

            data.forEach(item => {
                let option = document.createElement("option");
                option.value = item["Asset"];
                option.textContent = item["Asset"];
                assetDropdown.appendChild(option);
            });

            assetDropdown.addEventListener("change", () => updateAssetDetails(data));
            updateAssetDetails(data);
        }

        function updateAssetDetails(data) {
            const asset = document.getElementById("asset").value;
            const selectedAsset = data.find(item => item["Asset"] === asset);

            if (selectedAsset) {
                document.getElementById("dividend").value = selectedAsset["Dividend"];
                document.getElementById("interestRate").value = selectedAsset["Interest Rate (%)"];
                document.getElementById("volatility").value = "";

                const excelBaseDate = new Date(1899, 11, 30);
                const properDate = new Date(excelBaseDate.getTime() + selectedAsset["Dividend Date"] * 86400000);
                document.getElementById("dividendDate").value = properDate.toISOString().split('T')[0];
            }
        }

        function normalCDF(x) {
            return (1.0 + Math.erf(x / Math.sqrt(2.0))) / 2.0;
        }

        function calculateOptionPrice() {
            const asset = document.getElementById("asset").value;
            const spotPrice = parseFloat(document.getElementById("spotPrice").value);
            const daysToExpiry = parseInt(document.getElementById("daysToExpiry").value);
            const strike = parseFloat(document.getElementById("strike").value);
            const interestRate = parseFloat(document.getElementById("interestRate").value) / 100;
            const volatility = parseFloat(document.getElementById("volatility").value) / 100;
            const dividend = parseFloat(document.getElementById("dividend").value);
            const optionType = document.getElementById("optionType").value;

            if (isNaN(spotPrice) || isNaN(daysToExpiry) || isNaN(strike) || isNaN(interestRate) || isNaN(volatility) || isNaN(dividend)) {
                alert("Lütfen tüm alanları eksiksiz doldurun.");
                return;
            }

            const T = daysToExpiry / 365;
            const dividendYield = dividend / spotPrice;
            const adjustedSpotPrice = spotPrice * Math.exp(-dividendYield * T);

            const d1 = (Math.log(adjustedSpotPrice / strike) + (interestRate + (volatility ** 2) / 2) * T) / (volatility * Math.sqrt(T));
            const d2 = d1 - volatility * Math.sqrt(T);

            let optionPrice = optionType === "Call"
                ? (adjustedSpotPrice * normalCDF(d1)) - (strike * Math.exp(-interestRate * T) * normalCDF(d2))
                : (strike * Math.exp(-interestRate * T) * normalCDF(-d2)) - (adjustedSpotPrice * normalCDF(-d1));

            document.getElementById("optionPrice").value = optionPrice.toFixed(2);
        }
    </script>

</body>
</html>
