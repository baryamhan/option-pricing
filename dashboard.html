<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opsiyon Fiyatlama</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2 class="text-center">Hoş Geldiniz, <span id="username"></span></h2>

        <form id="optionForm" class="mt-4">
            <div class="row">
                <div class="col-md-6">
                    <label for="asset">Dayanak Varlık: (Seçiniz)</label>
                    <select id="asset" class="form-control" onchange="updateAssetDetails()"></select>
                </div>
                <div class="col-md-6">
                    <label for="spotPrice">Dayanak Varlık Fiyatı:</label>
                    <div class="d-flex align-items-center">
                        <input type="number" id="spotPrice" value="100" readonly class="form-control">
                        <input type="checkbox" id="manualSpot" onchange="toggleManualSpot()" class="ml-2">
                        <label for="manualSpot" class="ml-2">Elle Gir</label>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <label for="optionType">Opsiyon Türü: (Seçiniz)</label>
                    <select id="optionType" class="form-control">
                        <option value="Call" selected>Call</option>
                        <option value="Put">Put</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="strike">Kullanım Fiyatı: (Giriniz)</label>
                    <input type="number" id="strike" class="form-control">
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <label for="expiry">Vade Sonu Tarihi: (Seçiniz)</label>
                    <input type="date" id="expiry" class="form-control" onchange="calculateDaysToExpiry()">
                </div>
                <div class="col-md-6">
                    <label for="daysToExpiry">Vadeye Kalan Gün:</label>
                    <input type="number" id="daysToExpiry" readonly class="form-control">
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-4">
                    <label for="dividend">Temettü (Hisse Başına):</label>
                    <input type="number" id="dividend" readonly class="form-control">
                </div>
                <div class="col-md-4">
                    <label for="dividendDate">Temettü Tarihi:</label>
                    <input type="date" id="dividendDate" readonly class="form-control">
                </div>
                <div class="col-md-4">
                    <label for="interestRate">Faiz Oranı (%):</label>
                    <input type="number" id="interestRate" readonly class="form-control">
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <label for="volatility">Önerilen Volatilite (%):</label>
                    <input type="number" id="volatility" readonly placeholder="Hesaplandıktan sonra görünecek" class="form-control">
                </div>
                <div class="col-md-6">
                    <label>Önerilen Opsiyon Fiyatı:</label>
                    <input type="text" id="optionPrice" readonly class="form-control font-weight-bold">
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="button" class="btn btn-primary" onclick="calculateOptionPrice()">Hesapla</button>
                <button class="btn btn-danger ml-2" onclick="logout()">Çıkış Yap</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const loggedInUser = localStorage.getItem("loggedInUser");
            if (!loggedInUser) {
                alert("Lütfen önce giriş yapın!");
                window.location.href = "index.html";
            } else {
                document.getElementById("username").innerText = loggedInUser;
                loadDataForUser(loggedInUser);
            }
        });

        function loadDataForUser(user) {
            const jsonFile = user === "YBA" 
                ? "https://cdn.jsdelivr.net/gh/baryamhan/option-pricing@main/yba.json"
                : "https://cdn.jsdelivr.net/gh/baryamhan/option-pricing@main/sube.json";

            fetchData(jsonFile);
        }

	function toggleManualSpot() { 
	    const spotInput = document.getElementById("spotPrice");
	    const manualSpotCheckbox = document.getElementById("manualSpot");
	
	    if (manualSpotCheckbox.checked) {
	        spotInput.removeAttribute("readonly");
	    } else {
	        spotInput.setAttribute("readonly", true);
	        spotInput.value = 100; // Varsayılan değere geri döner
	    }
	}
    
        async function fetchData(jsonFile) {
            try {
                console.log("JSON Yükleniyor:", jsonFile);
                const response = await fetch(jsonFile);
                const data = await response.json();
                populateAssetDropdown(data);
            } catch (error) {
                console.error("JSON verisi çekilemedi:", error);
                alert("Verileri yüklerken hata oluştu. Lütfen konsolu kontrol edin.");
            }
        }

        function populateAssetDropdown(data) {
            const assetDropdown = document.getElementById("asset");
            assetDropdown.innerHTML = ""; 

            data.forEach(item => {
                let option = document.createElement("option");
                option.value = item["Asset"];
                option.textContent = item["Asset"];
                assetDropdown.appendChild(option);
            });

            assetDropdown.addEventListener("change", () => updateAssetDetails(data));
            updateAssetDetails(data);
        }

        function updateAssetDetails(data) {
            const asset = document.getElementById("asset").value;
            const selectedAsset = data.find(item => item["Asset"] === asset);

            if (selectedAsset) {
                document.getElementById("dividend").value = selectedAsset["Dividend"];
                document.getElementById("interestRate").value = selectedAsset["Interest Rate (%)"];
                document.getElementById("volatility").value = "";

                const excelBaseDate = new Date(1899, 11, 30);
                const properDate = new Date(excelBaseDate.getTime() + selectedAsset["Dividend Date"] * 86400000);
                document.getElementById("dividendDate").value = properDate.toISOString().split('T')[0];
            }
        }

	function calculateDaysToExpiry() {
        const expiryInput = document.getElementById("expiry").value;

        if (!expiryInput) {
            document.getElementById("daysToExpiry").value = "";
            return;
        }

        const expiryDate = new Date(expiryInput);
        const today = new Date();

        // Sadece tarih kısmını al (saat farkları sorun yaratmasın)
        const timeDiff = expiryDate.setHours(0, 0, 0, 0) - today.setHours(0, 0, 0, 0);
        const daysToExpiry = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

        if (daysToExpiry < 0) {
            alert("Seçilen vade tarihi geçmiş olamaz!");
            document.getElementById("expiry").value = "";
            document.getElementById("daysToExpiry").value = "";
            return;
        }

        document.getElementById("daysToExpiry").value = daysToExpiry;
    }

    document.getElementById("expiry").addEventListener("change", calculateDaysToExpiry);
	    
function normalCDF(x) {
    // Standart normal dağılım fonksiyonu (N(x)) için Gauss hata fonksiyonu yaklaşımı
    const p = 0.3275911;
    const a1 = 0.254829592;
    const a2 = -0.284496736;
    const a3 = 1.421413741;
    const a4 = -1.453152027;
    const a5 = 1.061405429;

    const sign = x < 0 ? -1 : 1;
    const absX = Math.abs(x) / Math.sqrt(2.0);
    const t = 1.0 / (1.0 + p * absX);
    
    // Gauss hata fonksiyonu (erf) için yaklaşım
    const erfApprox = 1 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-absX * absX);
    
    return 0.5 * (1.0 + sign * erfApprox);
}
	    
function calculateOptionPrice() {
    const asset = document.getElementById("asset").value;
    const spotPrice = parseFloat(document.getElementById("spotPrice").value);
    const daysToExpiry = parseInt(document.getElementById("daysToExpiry").value);
    const strike = parseFloat(document.getElementById("strike").value);
    const interestRate = parseFloat(document.getElementById("interestRate").value) / 100;

    // ✅ Call/Put seçimini `select` kutusundan alıyoruz
    const optionTypeElement = document.getElementById("optionType");
    if (!optionTypeElement) {
        alert("Hata: Call/Put seçimi için 'optionType' bulunamadı!");
        return;
    }
    const optionType = optionTypeElement.value;

    if (isNaN(spotPrice) || isNaN(daysToExpiry) || isNaN(strike) || isNaN(interestRate)) {
        alert("Lütfen tüm alanları eksiksiz doldurun.");
        return;
    }

    // ✅ Kullanıcı giriş bilgisine göre doğru JSON dosyasını seçiyoruz
    const loggedInUser = localStorage.getItem("loggedInUser");
    const jsonFile = loggedInUser === "YBA"
        ? "https://cdn.jsdelivr.net/gh/baryamhan/option-pricing@main/yba.json"
        : "https://cdn.jsdelivr.net/gh/baryamhan/option-pricing@main/sube.json";

    fetch(jsonFile)
        .then(response => response.json())
        .then(data => {
            const selectedAsset = data.find(item => item["Asset"] === asset);

            if (!selectedAsset) {
                alert("Hata: Seçili dayanak varlık JSON'da bulunamadı!");
                return;
            }

            // ✅ 1. ATMVol'ü JSON'dan al
            const atmVol = selectedAsset["Volatility (%)"] / 100;
		
            const dividend = selectedAsset["Dividend"];
            const dividendDate = new Date(document.getElementById("dividendDate").value);
            const expiryDate = new Date(document.getElementById("expiry").value);
            const today = new Date();
		
            document.getElementById("volatility").value = (volatility * 100).toFixed(2);

            // ✅ Eğer temettü tarihi geçmişteyse veya vade sonu tarihinden büyükse temettü verimi = 0
            let dividendYield = 0;
            if (dividendDate > today && dividendDate <= expiryDate) {
                dividendYield = dividend / spotPrice * 365 / daysToExpiry;
            }
		
            // ✅ 2. Slope sabit değer olarak -0.05
            const slope = -0.05;

	    // ✅ 2. Curvature'ları tanımla
	    let callcur = selectedAsset["Call Curvature"]
	    let putcur = selectedAsset["Put Curvature"]
		
            // ✅ 3. Forward fiyatını Euler yöntemiyle hesapla
            const fwd = spotPrice * Math.exp((interestRate - dividendYield) * (daysToExpiry / 365));
            
	    // ✅ 4. ln(Strike / Fwd) hesapla
            let logStrikeFwd = Math.log(strike / fwd);

            // ✅ 5. X değerini bul
            let X = (fwd > strike) 
                ? Math.max(logStrikeFwd, -0.5) 
                : Math.min(logStrikeFwd, 0.5);

            // ✅ 6. Adjusted Volatility hesapla Call/Put'a göre
	    const curvature = optionType === "Call" 
		? callcur 
		: putcur;

            let adjustedVolatility = (atmVol + (slope * X) + (Math.pow(X, 2) * 1.2));
		
	    // ✅ 7. Güncellenmiş volatiliteyi input'a yaz
            document.getElementById("volatility").value = (adjustedVolatility * 100).toFixed(2);
		
            // ✅ Vadeye kalan süre yıl cinsinden
            const T = daysToExpiry / 365;

            // ✅ Temettü düzeltilmiş spot fiyat
            const adjustedSpotPrice = spotPrice * Math.exp(-dividendYield * T);

            // ✅ Black-Scholes d1 ve d2 hesaplamaları
            const d1 = (Math.log(adjustedSpotPrice / strike) + (interestRate + (adjustedVolatility ** 2) / 2) * T) / (adjustedVolatility * Math.sqrt(T));
            const d2 = d1 - adjustedVolatility * Math.sqrt(T);

            let optionPrice;

            if (optionType === "Call") {
                optionPrice = (adjustedSpotPrice * normalCDF(d1)) - (strike * Math.exp(-interestRate * T) * normalCDF(d2));
            } else if (optionType === "Put") {
                optionPrice = (strike * Math.exp(-interestRate * T) * normalCDF(-d2)) - (adjustedSpotPrice * normalCDF(-d1));
            } else {
                alert("Hata: Geçersiz opsiyon türü!");
                return;
            }

            document.getElementById("optionPrice").value = optionPrice.toFixed(2);
        })
        .catch(error => {
            console.error("Hata:", error);
            alert("Veriler yüklenirken hata oluştu.");
        });
}



        function logout() {
            localStorage.removeItem("loggedInUser");
            window.location.href = "index.html";
        }
    </script>

</body>
</html>
