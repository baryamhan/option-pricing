<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opsiyon Fiyatlama</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="dashboard-container">
        <h2>Hoş Geldiniz, <span id="username"></span></h2>

        <form id="optionForm">
            <!-- Dayanak Varlık Seçimi -->
            <label for="asset">Dayanak Varlık:</label>
            <select id="asset" onchange="updateAssetDetails()"></select>

            <!-- Dayanak Fiyatı (Şimdilik 100, ileride API'den gelecek) -->
            <label for="spotPrice">Dayanak Fiyatı:</label>
            <input type="number" id="spotPrice" value="100" readonly>

            <!-- JSON'dan Gelecek Değerler -->
            <label for="volatility">Önerilen Volatilite (%):</label>
            <input type="number" id="volatility" readonly>

            <label for="dividend">Temettü Değeri:</label>
            <input type="number" id="dividend" readonly>

            <label for="dividendDate">Temettü Tarihi:</label>
            <input type="date" id="dividendDate" readonly>

            <!-- Kullanıcının Gireceği Değerler -->
            <label for="strike">Kullanım Fiyatı (Strike):</label>
            <input type="number" id="strike">

            <label for="expiry">Vade Sonu Tarihi:</label>
            <input type="date" id="expiry" onchange="calculateDaysToExpiry()">

            <!-- Vadeye Kalan Gün Sayısı -->
            <label for="daysToExpiry">Vadeye Kalan Gün:</label>
            <input type="number" id="daysToExpiry" readonly>

            <!-- Hesaplanan Opsiyon Fiyatı -->
            <button type="button" onclick="calculateOptionPrice()">Hesapla</button>

            <h3>Opsiyon Önerilen Fiyatı: <span id="optionPrice">-</span></h3>
        </form>

        <button onclick="logout()">Çıkış Yap</button>
    </div>

    <script>
        // Kullanıcının giriş yapıp yapmadığını kontrol et
        document.addEventListener("DOMContentLoaded", () => {
            const loggedInUser = localStorage.getItem("loggedInUser");

            if (!loggedInUser) {
                alert("Lütfen önce giriş yapın!");
                window.location.href = "index.html";
            } else {
                document.getElementById("username").innerText = loggedInUser;
                loadDataForUser(loggedInUser);
            }
        });

        function loadDataForUser(user) {
            // Kullanıcıya göre JSON dosyasını belirle
            const jsonFile = user === "YBA" 
                ? "https://raw.githubusercontent.com/baryamhan/option-pricing/main/yba.json"
                : "https://raw.githubusercontent.com/baryamhan/option-pricing/main/sube.json";

            fetchData(jsonFile);
        }

<script>
    async function fetchData(jsonFile) {
        try {
            console.log("JSON Yükleniyor:", jsonFile);
            const response = await fetch(jsonFile);
            if (!response.ok) {
                throw new Error(`HTTP Hatası! Durum: ${response.status}`);
            }

            const data = await response.json();
            console.log("JSON Verisi:", data); // JSON içeriğini kontrol edelim

            if (!Array.isArray(data)) {
                throw new Error("JSON formatı bir dizi (array) olmalı.");
            }

            populateAssetDropdown(data);
        } catch (error) {
            console.error("JSON verisi çekilemedi:", error);
            alert("Verileri yüklerken hata oluştu. Lütfen konsolu kontrol edin.");
        }
    }

    function populateAssetDropdown(data) {
        const assetDropdown = document.getElementById("asset");
        assetDropdown.innerHTML = ""; // Önce temizle

        data.forEach(item => {
            let option = document.createElement("option");
            option.value = item["Asset"];
            option.textContent = item["Asset"];
            assetDropdown.appendChild(option);
        });

        updateAssetDetails(data);
    }

    function updateAssetDetails(data) {
        const asset = document.getElementById("asset").value;
        const selectedAsset = data.find(item => item["Asset"] === asset);

        if (selectedAsset) {
            document.getElementById("volatility").value = selectedAsset["Volatility (%)"];
            document.getElementById("dividend").value = selectedAsset["Dividend"];

            // Excel tarihini YYYY-MM-DD formatına çevirme
            const excelBaseDate = new Date(1899, 11, 30);
            const properDate = new Date(excelBaseDate.getTime() + selectedAsset["Dividend Date"] * 86400000);
            document.getElementById("dividendDate").value = properDate.toISOString().split('T')[0];
        }
    }

    function calculateDaysToExpiry() {
        const expiryDate = new Date(document.getElementById("expiry").value);
        const today = new Date();
        const timeDiff = expiryDate - today;
        const daysToExpiry = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

        document.getElementById("daysToExpiry").value = daysToExpiry;
    }

    function calculateOptionPrice() {
        const spotPrice = parseFloat(document.getElementById("spotPrice").value);
        const interestRate = parseFloat(document.getElementById("volatility").value) / 100; // Kullanıcı JSON'dan gelen faiz oranını kullanacak
        const daysToExpiry = parseInt(document.getElementById("daysToExpiry").value);
        const strike = parseFloat(document.getElementById("strike").value);

        if (isNaN(spotPrice) || isNaN(interestRate) || isNaN(daysToExpiry) || isNaN(strike)) {
            alert("Lütfen tüm alanları doldurun.");
            return;
        }

        // Basit hesaplama formülü: Fiyat * (Faiz * Vade Gün Sayısı / 365) - Strike
        const optionPrice = (spotPrice * (interestRate * daysToExpiry / 365)) - strike;

        document.getElementById("optionPrice").innerText = optionPrice.toFixed(2);
    }

    function logout() {
        localStorage.removeItem("loggedInUser");
        window.location.href = "index.html";
    }
</script>

</body>
</html>
